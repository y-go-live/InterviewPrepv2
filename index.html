<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Interview Prep Tool</title>
  <style>
    /* green and black */
    body {
      background: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      color: #000000;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      border: 2px solid #007a33;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007a33;
      margin-bottom: 20px;
    }
    .upload-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 20px;
    }
    .upload-section div {
      flex: 1;
      min-width: 240px;
    }
    .upload-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #000;
    }
    .upload-section input {
      width: 100%;
      padding: 8px;
      border: 1px solid #007a33;
      border-radius: 5px;
    }
    .btn {
      background-color: #007a33;
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin: 5px;
      font-weight: bold;
    }
    .btn:hover {
      background-color: #005622;
    }
    .btn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .conversation-box {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #007a33;
      border-radius: 5px;
      background: #f8f8f8;
      max-height: 400px;
      overflow-y: auto;
    }
    .conversation-box h2 {
      margin-top: 0;
      color: #007a33;
    }
    .message {
      margin-bottom: 15px;
      line-height: 1.5;
    }
    .message.agent {
      color: #007a33;
      font-weight: bold;
    }
    .message.candidate {
      color: #000;
    }
    .record-section {
      margin-top: 20px;
      text-align: center;
    }
    .transcript-display {
      margin-top: 10px;
      padding: 10px;
      background: #e6f4ea;
      border: 1px dashed #007a33;
      border-radius: 5px;
      min-height: 50px;
      color: #000;
      white-space: pre-wrap;
    }
    /* Timer display */
    #timerDisplay {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      color: #007a33;
    }
    @media (max-width: 600px) {
      .upload-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Real-Time Interview Prep Tool</h1>
    
    <!-- File Uploads -->
    <div class="upload-section">
      <div>
        <label for="resume">Upload Resume (txt):</label>
        <input type="file" id="resume" accept=".txt" />
      </div>
      <div>
        <label for="jobDesc">Upload Job Description (txt):</label>
        <input type="file" id="jobDesc" accept=".txt" />
      </div>
    </div>
    
    <!-- Interview Controls -->
    <div style="text-align: center;">
      <button id="startInterviewBtn" class="btn">Start Interview</button>
      <button id="stopInterviewBtn" class="btn" disabled>Stop Interview</button>
      <button id="finishInterviewBtn" class="btn" disabled>Finish Interview</button>
    </div>
    
    <!-- Conversation Display -->
    <div class="conversation-box" id="conversation">
      <h2>Interview Conversation:</h2>
    </div>
    
    <!-- Recording Controls -->
    <div class="record-section">
      <button id="recordAnswerBtn" class="btn" disabled>Record Answer</button>
      <button id="submitAnswerBtn" class="btn" disabled>Submit Answer</button>
      <div class="transcript-display" id="transcriptDisplay">Your Answer: (none)</div>
      <div id="timerDisplay">Time left: 0s</div>
    </div>
    
    <!-- Final Analysis Display -->
    <div class="conversation-box" id="finalAnalysis" style="display: none;">
      <h2>Final Analysis:</h2>
      <div id="analysisText"></div>
    </div>
  </div>

  <script>
    // Global state variables
    let resumeContent = "";
    let jobDescContent = "";
    let currentQuestion = "";
    let conversationHistory = "";  // store conversation history
    let recognizing = false;
    let transcriptText = "";
    let timerInterval; // for countdown timer
    let currentTimerDuration = 0;

    // Calculate timer duration based on question length.
    // For example: base 10s + 2s per word, minimum 30 seconds.
    function getTimerDuration(question) {
      const words = question.trim().split(/\s+/).length;
      return Math.max(30, 10 + words * 2);
    }
    
    // Speech Synthesis helper function
    function speakText(text, callback) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.onend = () => { if (callback) callback(); };
      window.speechSynthesis.speak(utterance);
    }
    
    // Append a message and update conversation history
    function appendMessage(role, text) {
      const conversation = document.getElementById("conversation");
      const div = document.createElement("div");
      div.className = "message " + role;
      let label = (role === "agent") ? "Agent: " :
                  (role === "candidate") ? "You: " : "";
      div.textContent = label + text;
      conversation.appendChild(div);
      conversation.scrollTop = conversation.scrollHeight;
      conversationHistory += label + text + "\n";
    }
    
    // File reader helper
    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => resolve(event.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsText(file);
      });
    }
    
    // Timer functions
    function startTimer(duration) {
      clearInterval(timerInterval);
      currentTimerDuration = duration;
      const timerDisplay = document.getElementById("timerDisplay");
      timerDisplay.textContent = "Time left: " + currentTimerDuration + "s";
      timerInterval = setInterval(() => {
        currentTimerDuration--;
        timerDisplay.textContent = "Time left: " + currentTimerDuration + "s";
        if (currentTimerDuration <= 0) {
          clearInterval(timerInterval);
          // Auto-submit if answer exists; otherwise, alert the candidate.
          if (transcriptText.trim() !== "") {
            submitAnswer();
          } else {
            alert("Time is up! Please record your answer.");
            recordBtn.disabled = false;
            submitBtn.disabled = false;
          }
        }
      }, 1000);
    }
    
    function clearTimer() {
      clearInterval(timerInterval);
      document.getElementById("timerDisplay").textContent = "";
    }
    
    // Button elements
    const startBtn = document.getElementById("startInterviewBtn");
    const stopBtn = document.getElementById("stopInterviewBtn");
    const finishBtn = document.getElementById("finishInterviewBtn");
    const recordBtn = document.getElementById("recordAnswerBtn");
    const submitBtn = document.getElementById("submitAnswerBtn");
    
    // Submit answer function
    async function submitAnswer() {
      clearTimer();
      if (!transcriptText.trim()) {
        alert("Please record your answer first.");
        return;
      }
      appendMessage("candidate", transcriptText);
      const payload = {
        resume: resumeContent,
        job_desc: jobDescContent,
        current_question: currentQuestion,
        candidate_answer: transcriptText
      };
      try {
        const response = await fetch('/api/agent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        console.log("API result:", result);
        // Check for the next_question key.
        if (result.next_question) {
          currentQuestion = result.next_question;
          appendMessage("agent", currentQuestion);
          // Speak the next question and restart the timer.
          speakText(currentQuestion, () => {
            document.getElementById("transcriptDisplay").textContent = "Your Answer: (none)";
            transcriptText = "";
            recordBtn.disabled = false;
            submitBtn.disabled = true;
            startTimer(getTimerDuration(currentQuestion));
          });
        } else {
          alert("Unexpected response from API. Please check your endpoint.");
        }
      } catch (error) {
        console.error("API Error:", error);
        alert("There was an error processing your answer.");
      }
    }
    
    // Speech Recognition setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Speech Recognition API not supported in this browser.");
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.onresult = (event) => {
      transcriptText = Array.from(event.results)
        .map(result => result[0])
        .map(result => result.transcript)
        .join('');
      document.getElementById("transcriptDisplay").textContent = "Your Answer: " + transcriptText;
    };
    recognition.onend = () => {
      recognizing = false;
      recordBtn.disabled = false;
      submitBtn.disabled = false;
    };
    
    // Button events
    startBtn.addEventListener("click", async () => {
      const resumeFile = document.getElementById("resume").files[0];
      const jobDescFile = document.getElementById("jobDesc").files[0];
      if (!resumeFile || !jobDescFile) {
        alert("Please upload both your resume and job description.");
        return;
      }
      resumeContent = await readFileContent(resumeFile);
      jobDescContent = await readFileContent(jobDescFile);
      document.getElementById("resume").disabled = true;
      document.getElementById("jobDesc").disabled = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      recordBtn.disabled = false;
      finishBtn.disabled = false;
      
      // Start with a default question and timer.
      currentQuestion = "Tell me about yourself.";
      appendMessage("agent", currentQuestion);
      speakText(currentQuestion, () => {
        startTimer(getTimerDuration(currentQuestion));
      });
    });
    
    stopBtn.addEventListener("click", () => {
      recordBtn.disabled = true;
      submitBtn.disabled = true;
      stopBtn.disabled = true;
      clearTimer();
      alert("Interview has been stopped. Click 'Finish Interview' to get your overall analysis.");
    });
    
    recordBtn.addEventListener("click", () => {
      if (recognizing) return;
      transcriptText = "";
      document.getElementById("transcriptDisplay").textContent = "Your Answer: (recording...)";
      submitBtn.disabled = true;
      recordBtn.disabled = true;
      recognizing = true;
      recognition.start();
    });
    
    submitBtn.addEventListener("click", async () => {
      await submitAnswer();
    });
    
    finishBtn.addEventListener("click", async () => {
      recordBtn.disabled = true;
      submitBtn.disabled = true;
      stopBtn.disabled = true;
      finishBtn.disabled = true;
      clearTimer();
      const payload = {
        resume: resumeContent,
        job_desc: jobDescContent,
        conversation: conversationHistory
      };
      try {
        const response = await fetch('/api/final_analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if(result.final_analysis) {
          const analysisDiv = document.getElementById("finalAnalysis");
          document.getElementById("analysisText").textContent = result.final_analysis;
          analysisDiv.style.display = "block";
          speakText("Here is your overall interview analysis. Please review the analysis on screen.");
        } else {
          alert("Unexpected response from final analysis API.");
        }
      } catch (error) {
        console.error("Final Analysis API Error:", error);
        alert("There was an error getting your final analysis.");
      }
    });
  </script>
</body>
</html>
